<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Lua,">










<meta name="description" content="日神杀实例——马神加强版的编写">
<meta name="keywords" content="Lua">
<meta property="og:type" content="article">
<meta property="og:title" content="马超就是神">
<meta property="og:url" content="http://dzdcyj.github.io/2020/08/25/machao/index.html">
<meta property="og:site_name" content="CYJ的个人博客">
<meta property="og:description" content="日神杀实例——马神加强版的编写">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-08-26T06:36:04.967Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="马超就是神">
<meta name="twitter:description" content="日神杀实例——马神加强版的编写">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://dzdcyj.github.io/2020/08/25/machao/">





  <title>马超就是神 | CYJ的个人博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/DZDcyj"><img style=" position:absolute; top:0;left:0;border:0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_red_aa0000.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CYJ的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dzdcyj.github.io/2020/08/25/machao/index.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/blog-logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYJ的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">马超就是神</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-25T00:38:06+08:00">
                2020-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Lua/" itemprop="url" rel="index">
                    <span itemprop="name">Lua</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.7k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  25 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>日神杀实例——马神加强版的编写<br><a id="more"></a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>基于一些原因，最近打日神杀上头。在群友的怂恿下写了几个强力武将。其中就有阴间武将界徐盛，以及我们马上要提到的马超马孟起的界限突破界限突破版（大雾）。闲话休提，直奔主题，我们立即动手。</p>
<h1 id="动手写代码"><a href="#动手写代码" class="headerlink" title="动手写代码"></a>动手写代码</h1><h2 id="创建我们的武将"><a href="#创建我们的武将" class="headerlink" title="创建我们的武将"></a>创建我们的武将</h2><p>在前一篇的<code>Lua实战</code>中，笔者已经简述了如何创建自己的新武将，因此在这里不再赘述。我们直接使用如下的代码即可：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MachaoPlus = sgs.General(extension, <span class="string">'MachaoPlus'</span>, <span class="string">'shu'</span>, <span class="string">'4'</span>, <span class="literal">true</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="设计我们的武将技能"><a href="#设计我们的武将技能" class="headerlink" title="设计我们的武将技能"></a>设计我们的武将技能</h2><p>由于普通的马神太容易断杀了，再加上日神杀 AI 对原版【铁骑】的响应太蠢（完全不弃牌，仅在特定情况会脱装备），因此综合考虑，有如下的设计：（加粗部分是和原版不同的地方）<br><em>马术：锁定技，你计算与其他角色的距离-1；<b>若你于出牌阶段未使用【杀】造成过伤害，你于结束阶段结束时，可以视为使用一张无距离限制的【杀】</b></em><br><em>铁骑：当你使用【杀】指定一个目标后，你可以令其于此回合内锁定技以外的技能无效，然后你判定，令其选择是否弃置与结果花色相同的一张牌，若其选择否，其不能使用【闪】响应此【杀】，<b>且此【杀】造成的伤害+1</b></em></p>
<h2 id="动手写码"><a href="#动手写码" class="headerlink" title="动手写码"></a>动手写码</h2><p>在此之前，我们可以考虑参考已有的代码，马神的代码是刻在了源码里的，因此我们可以去官方的仓库里参照一下。而马术作为一个标准的距离修改技能以及一个阶段触发技的合体，我们完全有能力自己动手。所以我们即刻开始动工！</p>
<h3 id="马术"><a href="#马术" class="headerlink" title="马术"></a>马术</h3><p>作为一个杂糅技能，我们首先还是考虑马术的额外功能：未使用【杀】造成伤害，回合结束后可以使用一张无距离限制的【杀】。我们需要考虑的是两点，第一，判断回合内是否造成过【杀】的伤害，第二，选择目标。至于回合内是否造成过【杀】的伤害，我们可以参考技能【生息】，但实际上效果并不理想（可能是我哪里错了），因此我们做如下考虑。</p>
<h4 id="触发时机"><a href="#触发时机" class="headerlink" title="触发时机"></a>触发时机</h4><p>造成伤害后：我们使用【杀】造成伤害之后，需要设立一个标记（mark）或者 flag，来表示我们已经【杀】到掉血了。<br>阶段结束时：在回合结束阶段，我们需要检测是否具有对应的标记，若有，提示玩家选择目标；否则消除标记。</p>
<h4 id="代码部分"><a href="#代码部分" class="headerlink" title="代码部分"></a>代码部分</h4><p>综上，我们基本的代码框架已经出来了：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LuaMashu = sgs.CreateTriggerSkill &#123;</span><br><span class="line">    name = <span class="string">'LuaMashu'</span>,</span><br><span class="line">    frequency = sgs.Skill_Compulsory,</span><br><span class="line">    events = &#123;sgs.Damage, sgs.EventPhaseEnd&#125;,</span><br><span class="line">    on_trigger = <span class="function"><span class="keyword">function</span><span class="params">(self, event, player, data, room)</span></span></span><br><span class="line">        <span class="comment">-- 在新的 extra.lua 里，已经将 room 放在参数里了，因此可以省去 getRoom() 这一步</span></span><br><span class="line">        <span class="keyword">if</span> event == sgs.Damage <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 处理【杀】造成的伤害，添加标记</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.EventPhaseEnd <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 判断阶段并根据标记有无进行处理</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="伤害处理"><a href="#伤害处理" class="headerlink" title="伤害处理"></a>伤害处理</h5><p>伤害处理很简单，我们只需要在造成伤害后，判断是否为【杀】造成的伤害即可，参见如下代码：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> player:getPhase() == sgs.Player_Play <span class="keyword">and</span> player:hasSkill(self:objectName()) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 判断玩家是否是处于“出牌阶段”，是否拥有技能（其实可以略去，不指明 can_trigger 的情况下，默认有此条件）</span></span><br><span class="line">    <span class="keyword">local</span> damage = data:toDamage()</span><br><span class="line">    <span class="comment">-- data 是一个很神奇的东西，在这里我们使用 toDamage() 方法将其转换为对应的 damageStruct，具体的结构可以参看源码</span></span><br><span class="line">    <span class="keyword">if</span> damage <span class="keyword">and</span> damage.card <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 判断 damage 是否存在（其实可以不用），造成 damage 的卡牌是否存在</span></span><br><span class="line">        <span class="keyword">if</span> damage.card:isKindOf(<span class="string">'Slash'</span>) <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 如果这张卡存在，并且是【杀】（注意 Slash 开头大写，其他的卡牌类型也可以在源码中查看）</span></span><br><span class="line">            room:addPlayerMark(damage.from, <span class="string">'MashuSlashDamage'</span>)</span><br><span class="line">            <span class="comment">-- 对造成伤害的角色添加对应的标记（标记名可以自定义）</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h5 id="结束阶段判断"><a href="#结束阶段判断" class="headerlink" title="结束阶段判断"></a>结束阶段判断</h5><p>同样的，在回合结束阶段末尾，我们判断标记是否存在即可。<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> player:getPhase() == sgs.Player_Finish <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> player:getMark(<span class="string">'MashuSlashDamage'</span>) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 如果我们拥有的标记为0，代表我们未在出牌阶段以【杀】造成过伤害</span></span><br><span class="line">        <span class="keyword">local</span> victim = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), <span class="string">'@LuaMashuSlashTo'</span>, <span class="literal">true</span>, <span class="literal">true</span>)</span><br><span class="line">        <span class="comment">-- 提示选择目标</span></span><br><span class="line">        <span class="comment">--[[</span></span><br><span class="line"><span class="comment">            在这里我们参看源码，获取 askForPlayerChosen 函数的参数信息</span></span><br><span class="line"><span class="comment">            ServerPlayer *askForPlayerChosen(ServerPlayer *player, const QList&lt;ServerPlayer *&gt; &amp;targets, const QString &amp;reason, const QString &amp;prompt = QString(), bool optional = false, bool notify_skill = false);</span></span><br><span class="line"><span class="comment">            它返回了一个 ServerPlayer 对象，也就是一个角色，我们在这里不做深究，在这里的参数类型我们也不过多深究，包括指针啥的也不做讨论</span></span><br><span class="line"><span class="comment">            参数分别为：</span></span><br><span class="line"><span class="comment">            player：询问的目标对象</span></span><br><span class="line"><span class="comment">            targets：供选择的目标列表，通常使用的是 room:getAlivePlayers() 获取存活的所有角色，room:getOtherPlayers(except) 获取除 except 外的所有角色</span></span><br><span class="line"><span class="comment">            reason：理由，可以用 self:objectName()，玩家不可见</span></span><br><span class="line"><span class="comment">            prompt：提示格式，也就是显示在手牌上方的一行字，可以支持格式字符串（默认为空）</span></span><br><span class="line"><span class="comment">            optional：可选（默认为否），即玩家是否可以选择放弃选择角色</span></span><br><span class="line"><span class="comment">            notify_skill：是否提示发动技能（默认为否），你选择一名玩家后，是否在提示栏里显示“XX 发动了 YY，目标是 ZZ”</span></span><br><span class="line"><span class="comment">        ]]</span><span class="comment">--</span></span><br><span class="line">        <span class="keyword">if</span> victim <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 如果有我们的对应目标</span></span><br><span class="line">            <span class="keyword">local</span> slash = sgs.Sanguosha:cloneCard(<span class="string">'slash'</span>, sgs.Card_NoSuit, <span class="number">0</span>)</span><br><span class="line">            slash:setSkillName(self:objectName())</span><br><span class="line">            <span class="comment">-- 我们创建一张虚拟的【杀】，并以我们的“马术”作为他的技能名</span></span><br><span class="line">            room:useCard(sgs.CardUseStruct(slash, player, victim))</span><br><span class="line">            <span class="comment">-- 对目标使用【杀】</span></span><br><span class="line">            <span class="comment">--[[</span></span><br><span class="line"><span class="comment">                这是 useCard 的源码</span></span><br><span class="line"><span class="comment">                bool useCard(const CardUseStruct &amp;card_use, bool add_history = false);</span></span><br><span class="line"><span class="comment">                我们一般不考虑后续参数，只关注前面的 CardUseStruct 即可</span></span><br><span class="line"><span class="comment">                对于此，我们在后面列出(看看就好)</span></span><br><span class="line"><span class="comment">                我们关心其中的一条构造函数：</span></span><br><span class="line"><span class="comment">                CardUseStruct(const Card *card, ServerPlayer *from, ServerPlayer *target, bool isOwnerUse = true);</span></span><br><span class="line"><span class="comment">                我们指定对应的卡牌，使用者、目标即可（目标也可以是一个 list），最后的参数我们忽略他</span></span><br><span class="line"><span class="comment">                对应的就是 slash - 虚拟的【杀】 player - 当前的角色，也即是玩家 victim - 受害者</span></span><br><span class="line"><span class="comment">                因此返回了一个 player 使用 slash 目标是 victim 的 CardUseStruct</span></span><br><span class="line"><span class="comment">                然后再由 room 执行这个 CardUseStruct，完成【杀】的使用过程</span></span><br><span class="line"><span class="comment">            ]]</span><span class="comment">--</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    room:setPlayerMark(player, <span class="string">'MashuSlashDamage'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">-- 标记清空</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>这里是 <code>CardUseStruct</code> 的源代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CardUseStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">enum</span> CardUseReason</span><br><span class="line">    &#123;</span><br><span class="line">        CARD_USE_REASON_UNKNOWN = <span class="number">0x00</span>,</span><br><span class="line">        CARD_USE_REASON_PLAY = <span class="number">0x01</span>,</span><br><span class="line">        CARD_USE_REASON_RESPONSE = <span class="number">0x02</span>,</span><br><span class="line">        CARD_USE_REASON_RESPONSE_USE = <span class="number">0x12</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    CardUseStruct();</span><br><span class="line">    CardUseStruct(<span class="keyword">const</span> Card *card, ServerPlayer *from, QList&lt;ServerPlayer *&gt; to, <span class="keyword">bool</span> isOwnerUse = <span class="literal">true</span>);</span><br><span class="line">    CardUseStruct(<span class="keyword">const</span> Card *card, ServerPlayer *from, ServerPlayer *target, <span class="keyword">bool</span> isOwnerUse = <span class="literal">true</span>);</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValid</span><span class="params">(<span class="keyword">const</span> QString &amp;pattern)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">parse</span><span class="params">(<span class="keyword">const</span> QString &amp;str, Room *room)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">tryParse</span><span class="params">(<span class="keyword">const</span> QVariant &amp;usage, Room *room)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> Card *card;</span><br><span class="line">    ServerPlayer *from;</span><br><span class="line">    QList&lt;ServerPlayer *&gt; to;</span><br><span class="line">    <span class="keyword">bool</span> m_isOwnerUse;</span><br><span class="line">    <span class="keyword">bool</span> m_addHistory;</span><br><span class="line">    <span class="keyword">bool</span> m_isHandcard;</span><br><span class="line">    QStringList nullified_list;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h5 id="基础马术"><a href="#基础马术" class="headerlink" title="基础马术"></a>基础马术</h5><p>基于此，我们的额外部分设计完成，当然，还有基础套餐也要加上，也即是：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LuaMashuDistance = sgs.CreateDistanceSkill &#123;</span><br><span class="line">    <span class="comment">-- 对于距离修改技能，他是可以不“在场”生效的</span></span><br><span class="line">    <span class="comment">-- 也即是说，只要有角色拥有这个技能，他的修正就会存在</span></span><br><span class="line">    <span class="comment">-- 因此我们用技能暗将获取这个技能即可</span></span><br><span class="line">    name = <span class="string">'LuaMashuDistance'</span>,</span><br><span class="line">    correct_func = <span class="function"><span class="keyword">function</span><span class="params">(self, from, to)</span></span></span><br><span class="line">        <span class="keyword">if</span> from:hasSkill(<span class="string">'LuaMashu'</span>) <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">-1</span> <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 如果计算起始角色拥有技能“马术（新）”，那么对距离做 -1 的修正</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="总代码"><a href="#总代码" class="headerlink" title="总代码"></a>总代码</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">LuaMashu = sgs.CreateTriggerSkill &#123;</span><br><span class="line">    name = <span class="string">'LuaMashu'</span>,</span><br><span class="line">    frequency = sgs.Skill_Compulsory,</span><br><span class="line">    events = &#123;sgs.Damage, sgs.EventPhaseEnd&#125;,</span><br><span class="line">    on_trigger = <span class="function"><span class="keyword">function</span><span class="params">(self, event, player, data, room)</span></span></span><br><span class="line">        <span class="keyword">if</span> event == sgs.Damage <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> player:getPhase() == sgs.Player_Play <span class="keyword">and</span></span><br><span class="line">                player:hasSkill(self:objectName()) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> damage = data:toDamage()</span><br><span class="line">                <span class="keyword">if</span> damage <span class="keyword">and</span> damage.card <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> damage.card:isKindOf(<span class="string">'Slash'</span>) <span class="keyword">then</span></span><br><span class="line">                        room:addPlayerMark(damage.from, <span class="string">'MashuSlashDamage'</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.EventPhaseEnd <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> player:getPhase() == sgs.Player_Finish <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> player:getMark(<span class="string">'MashuSlashDamage'</span>) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">local</span> victim = room:askForPlayerChosen(player,</span><br><span class="line">                                                           room:getOtherPlayers(</span><br><span class="line">                                                               player),</span><br><span class="line">                                                           self:objectName(),</span><br><span class="line">                                                           <span class="string">'@LuaMashuSlashTo'</span>,</span><br><span class="line">                                                           <span class="literal">true</span>, <span class="literal">true</span>)</span><br><span class="line">                    <span class="keyword">if</span> victim <span class="keyword">then</span></span><br><span class="line">                        <span class="keyword">local</span> slash = sgs.Sanguosha:cloneCard(<span class="string">'slash'</span>,</span><br><span class="line">                                                              sgs.Card_NoSuit, <span class="number">0</span>)</span><br><span class="line">                        slash:setSkillName(self:objectName())</span><br><span class="line">                        room:useCard(sgs.CardUseStruct(slash, player, victim))</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                room:setPlayerMark(player, <span class="string">'MashuSlashDamage'</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line">LuaMashuDistance = sgs.CreateDistanceSkill &#123;</span><br><span class="line">    name = <span class="string">'LuaMashuDistance'</span>,</span><br><span class="line">    correct_func = <span class="function"><span class="keyword">function</span><span class="params">(self, from, to)</span></span></span><br><span class="line">        <span class="keyword">if</span> from:hasSkill(<span class="string">'LuaMashu'</span>) <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">-1</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MachaoPlus:addSkill(LuaMashu)</span><br><span class="line">SkillAnjiang:addSkill(LuaMashuDistance)</span><br><span class="line"><span class="comment">-- 为我们的马超和暗将安排技能</span></span><br><span class="line"><span class="comment">-- 暗将的声明如下：SkillAnjiang = sgs.General(extension, 'SkillAnjiang', 'god', '6', true, true, true)</span></span><br><span class="line"><span class="comment">-- 最后一个参数代表其不会在武将一览中出现，彻底地被隐藏</span></span><br></pre></td></tr></table></figure>
<h3 id="铁骑"><a href="#铁骑" class="headerlink" title="铁骑"></a>铁骑</h3><p>铁骑是一个标准的触发技能，我们基于原版的 C++ 铁骑代码进行修正即可。</p>
<h4 id="触发时机-1"><a href="#触发时机-1" class="headerlink" title="触发时机"></a>触发时机</h4><p>根据技能描述，我们对于铁骑的触发时机有如下考虑：<br>指定目标后（TargetSpecified）：使用【杀】指定目标后，询问玩家是否发动技能<br>造成伤害时（DamageCaused）：造成伤害时，判断是否符合条件<br>判定结束后（FinishJudge）：处理无法闪避的问题<br>注意，我们的技能封锁只持续一个回合，因此解铃还须系铃人，还有下列的触发时机：<br>卡牌结算后（CardFinished）：处理伤害增加的解除<br>阶段切换时（EventPhaseChanging）：处理标记等<br>死亡时（Death）：处理标记等  </p>
<h4 id="参考源码"><a href="#参考源码" class="headerlink" title="参考源码"></a>参考源码</h4><p>这里列出了对应的源码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tieji</span> :</span> <span class="keyword">public</span> TriggerSkill</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Tieji() : TriggerSkill(<span class="string">"tieji"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        events &lt;&lt; TargetSpecified &lt;&lt; FinishJudge;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">triggerable</span><span class="params">(<span class="keyword">const</span> ServerPlayer *target)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target != <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">trigger</span><span class="params">(TriggerEvent triggerEvent, Room *room, ServerPlayer *player, QVariant &amp;data)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (triggerEvent == TargetSpecified &amp;&amp; TriggerSkill::triggerable(player)) &#123;</span><br><span class="line">            CardUseStruct use = data.value&lt;CardUseStruct&gt;();</span><br><span class="line">            <span class="keyword">if</span> (!use.card-&gt;isKindOf(<span class="string">"Slash"</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            QVariantList jink_list = player-&gt;tag[<span class="string">"Jink_"</span> + use.card-&gt;toString()].toList();</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            QList&lt;ServerPlayer *&gt; tos;</span><br><span class="line">            foreach (ServerPlayer *p, use.to) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!player-&gt;isAlive()) <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (player-&gt;askForSkillInvoke(<span class="keyword">this</span>, QVariant::fromValue(p))) &#123;</span><br><span class="line">                    room-&gt;broadcastSkillInvoke(objectName());</span><br><span class="line">                    <span class="keyword">if</span> (!tos.contains(p)) &#123;</span><br><span class="line">                        p-&gt;addMark(<span class="string">"tieji"</span>);</span><br><span class="line">                        room-&gt;addPlayerMark(p, <span class="string">"@skill_invalidity"</span>);</span><br><span class="line">                        tos &lt;&lt; p;</span><br><span class="line"></span><br><span class="line">                        foreach(ServerPlayer *pl, room-&gt;getAllPlayers())</span><br><span class="line">                            room-&gt;filterCards(pl, pl-&gt;getCards(<span class="string">"he"</span>), <span class="literal">true</span>);</span><br><span class="line">                        JsonArray args;</span><br><span class="line">                        args &lt;&lt; QSanProtocol::S_GAME_EVENT_UPDATE_SKILL;</span><br><span class="line">                        room-&gt;doBroadcastNotify(QSanProtocol::S_COMMAND_LOG_EVENT, args);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    JudgeStruct judge;</span><br><span class="line">                    judge.pattern = <span class="string">"."</span>;</span><br><span class="line">                    judge.good = <span class="literal">true</span>;</span><br><span class="line">                    judge.reason = objectName();</span><br><span class="line">                    judge.who = player;</span><br><span class="line">                    judge.play_animation = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                    room-&gt;judge(judge);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ((p-&gt;isAlive() &amp;&amp; !p-&gt;canDiscard(p, <span class="string">"he"</span>))</span><br><span class="line">                        || !room-&gt;askForCard(p, <span class="string">".|"</span> + judge.pattern, <span class="string">"@tieji-discard:::"</span> + judge.pattern, data, Card::MethodDiscard)) &#123;</span><br><span class="line">                        LogMessage <span class="built_in">log</span>;</span><br><span class="line">                        <span class="built_in">log</span>.type = <span class="string">"#NoJink"</span>;</span><br><span class="line">                        <span class="built_in">log</span>.from = p;</span><br><span class="line">                        room-&gt;sendLog(<span class="built_in">log</span>);</span><br><span class="line">                        jink_list.replace(index, QVariant(<span class="number">0</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                index++;</span><br><span class="line">            &#125;</span><br><span class="line">            player-&gt;tag[<span class="string">"Jink_"</span> + use.card-&gt;toString()] = QVariant::fromValue(jink_list);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (triggerEvent == FinishJudge) &#123;</span><br><span class="line">            JudgeStruct *judge = data.value&lt;JudgeStruct *&gt;();</span><br><span class="line">            <span class="keyword">if</span> (judge-&gt;reason == objectName()) &#123;</span><br><span class="line">                judge-&gt;pattern = judge-&gt;card-&gt;getSuitString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TiejiClear</span> :</span> <span class="keyword">public</span> TriggerSkill</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    TiejiClear() : TriggerSkill(<span class="string">"#tieji-clear"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        events &lt;&lt; EventPhaseChanging &lt;&lt; Death;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPriority</span><span class="params">(TriggerEvent)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">triggerable</span><span class="params">(<span class="keyword">const</span> ServerPlayer *target)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target != <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">trigger</span><span class="params">(TriggerEvent triggerEvent, Room *room, ServerPlayer *target, QVariant &amp;data)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (triggerEvent == EventPhaseChanging) &#123;</span><br><span class="line">            PhaseChangeStruct change = data.value&lt;PhaseChangeStruct&gt;();</span><br><span class="line">            <span class="keyword">if</span> (change.to != Player::NotActive)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (triggerEvent == Death) &#123;</span><br><span class="line">            DeathStruct death = data.value&lt;DeathStruct&gt;();</span><br><span class="line">            <span class="keyword">if</span> (death.who != target || target != room-&gt;getCurrent())</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        QList&lt;ServerPlayer *&gt; players = room-&gt;getAllPlayers();</span><br><span class="line">        foreach (ServerPlayer *player, players) &#123;</span><br><span class="line">            <span class="keyword">if</span> (player-&gt;getMark(<span class="string">"tieji"</span>) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            room-&gt;removePlayerMark(player, <span class="string">"@skill_invalidity"</span>, player-&gt;getMark(<span class="string">"tieji"</span>));</span><br><span class="line">            player-&gt;setMark(<span class="string">"tieji"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            foreach(ServerPlayer *p, room-&gt;getAllPlayers())</span><br><span class="line">                room-&gt;filterCards(p, p-&gt;getCards(<span class="string">"he"</span>), <span class="literal">false</span>);</span><br><span class="line">            JsonArray args;</span><br><span class="line">            args &lt;&lt; QSanProtocol::S_GAME_EVENT_UPDATE_SKILL;</span><br><span class="line">            room-&gt;doBroadcastNotify(QSanProtocol::S_COMMAND_LOG_EVENT, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看到源码把它拆成了两个技能，但是实际使用中，我们会在小型场景/执行底端脚本中添加技能，如果只添加主技能，会有各种各样的问题，添加副技能也略显麻烦，基于此，我们还是考虑合并为一个技能。</p>
<h4 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a>基本框架</h4><p>我们将源码 lua 化，然后抽出主要框架如下：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">LuaTieji = sgs.CreateTriggerSkill &#123;</span><br><span class="line">    name = <span class="string">'LuaTieji'</span>,</span><br><span class="line">    frequency = sgs.Skill_NotFrequent,</span><br><span class="line">    events = &#123;</span><br><span class="line">        sgs.TargetSpecified, sgs.FinishJudge, sgs.EventPhaseChanging, sgs.Death,</span><br><span class="line">        sgs.DamageCaused, sgs.CardFinished</span><br><span class="line">    &#125;,</span><br><span class="line">    on_trigger = <span class="function"><span class="keyword">function</span><span class="params">(self, event, player, data, room)</span></span></span><br><span class="line">        <span class="keyword">if</span> event == sgs.TargetSpecified <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 处理询问等事件，包括不能闪避也在这里</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.FinishJudge <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 在这里根据判定结果对以上的询问的字符串做格式化处理</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.DamageCaused <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 处理伤害增加</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.CardFinished <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 处理解除伤害增加</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">-- 处理标记的消除</span></span><br><span class="line">            <span class="keyword">if</span> event == sgs.EventPhaseChanging <span class="keyword">then</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">elseif</span> event == sgs.Death <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">-- 不同的时机需要不同的判断标准</span></span><br><span class="line">            <span class="comment">-- 下面就处理标记的移除等</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    can_trigger = <span class="function"><span class="keyword">function</span><span class="params">(self, target)</span></span> <span class="keyword">return</span> target <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 由于【铁骑】可以在回合外发动，因此需要考虑全局性，所以 can_trigger 需要重写</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="目标选择时"><a href="#目标选择时" class="headerlink" title="目标选择时"></a>目标选择时</h4><p>首先我们处理 TargetSpecified 这一时机的问题，很简单，我们照着源码翻译下来就可以了，为了对应源码中的 <code>triggerable</code>，我们定义一个函数 <code>RIGHT</code> 来处理：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RIGHT</span><span class="params">(self, player)</span></span></span><br><span class="line">    <span class="keyword">if</span> player <span class="keyword">and</span> player:isAlive() <span class="keyword">and</span> player:hasSkill(self:objectName()) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>这个函数帮助游戏筛选是否符合条件（存活、有技能），因为我们重写了 <code>can_trigger</code>，所以是必要的，如果没有这几个判断，系统会对所有玩家在出【杀】时进行询问，这显然不符合设计初衷。<br>翻译过来的代码如下：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> RIGHT(self, player) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 如果玩家符合我们的条件，拥有技能且存活（注意这里的 player 不是通常的玩家）</span></span><br><span class="line">    <span class="keyword">local</span> use = data:toCardUse()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> use.card:isKindOf(<span class="string">'Slash'</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 获取 CardUseStruct 并判断卡牌类型</span></span><br><span class="line">    <span class="keyword">local</span> jink_table = sgs.QList2Table(player:getTag(<span class="string">"Jink_"</span> .. use.card:toString()):toIntList())</span><br><span class="line">    <span class="keyword">local</span> index = <span class="number">1</span></span><br><span class="line">    <span class="comment">-- jink_table 这东西超纲了（），可以做如下理解，一个格子代表闪的使用情况，同样的效果可以使用 room:slashResult() 函数进行替代</span></span><br><span class="line">    <span class="keyword">local</span> tos = sgs.SPlayerList()</span><br><span class="line">    <span class="comment">-- 创建玩家列表</span></span><br><span class="line">    <span class="keyword">for</span> _, p <span class="keyword">in</span> sgs.qlist(use.to) <span class="keyword">do</span></span><br><span class="line">        <span class="comment">-- 对于所有的指定为该【杀】的玩家</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> player:isAlive() <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 如果已阵亡，则跳过</span></span><br><span class="line">        <span class="keyword">local</span> data2 = sgs.QVariant()</span><br><span class="line">        data2:setValue(p)</span><br><span class="line">        <span class="keyword">if</span> room:askForSkillInvoke(player, self:objectName(), data2) <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 最后一个参数显示为“你想对 XX 发动技能 YY 吗”</span></span><br><span class="line">            room:broadcastSkillInvoke(self:objectName())</span><br><span class="line">            <span class="comment">-- 播放技能语音</span></span><br><span class="line">            <span class="comment">-- 常用的原型为：    void broadcastSkillInvoke(const QString &amp;skillName, int type);</span></span><br><span class="line">            <span class="comment">-- 前一个是技能名称，后一个是第几个语音，不指定时随机播放</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> tos:contains(p) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">-- 防止重复询问</span></span><br><span class="line">                room:addPlayerMark(p, <span class="string">'LuaTieji'</span>)</span><br><span class="line">                room:addPlayerMark(p, <span class="string">'@skill_invalidity'</span>)</span><br><span class="line">                <span class="comment">-- @skill_invalidity 标记实现了非锁定技失效的功能</span></span><br><span class="line">                <span class="comment">-- LuaTieji 用于计数，消去 @skill_invalidity 时使用</span></span><br><span class="line">                room:doAnimate(<span class="number">1</span>, player:objectName(), p:objectName())</span><br><span class="line">                <span class="comment">-- 画线，从 player 指向 p</span></span><br><span class="line">                tos:append(p)</span><br><span class="line">                <span class="comment">-- 将 p 添加进列表，防止重复询问</span></span><br><span class="line">                <span class="keyword">for</span> _, pl <span class="keyword">in</span> sgs.qlist(room:getAllPlayers()) <span class="keyword">do</span></span><br><span class="line">                    room:filterCards(pl, pl:getCards(<span class="string">'he'</span>), <span class="literal">true</span>)</span><br><span class="line">                    <span class="comment">-- 修改要求弃牌时的选择，h - 手牌区，e - 装备区</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">local</span> judge = sgs.JudgeStruct()</span><br><span class="line">            <span class="comment">-- 定义判定结构体</span></span><br><span class="line">            judge.pattern = <span class="string">"."</span></span><br><span class="line">            <span class="comment">-- 判定的类型，这里是无论如何都成功，例如可以填成 heart 等</span></span><br><span class="line">            judge.good = <span class="literal">true</span></span><br><span class="line">            <span class="comment">-- 这里为 true，代表符合上述 pattern 的视为成功</span></span><br><span class="line">            <span class="comment">-- 反之为 false 时符合 pattern 的视为实败</span></span><br><span class="line">            judge.reason = self:objectName()</span><br><span class="line">            <span class="comment">-- 判定理由</span></span><br><span class="line">            judge.who = player</span><br><span class="line">            <span class="comment">-- 执行判定的人</span></span><br><span class="line">            judge.play_animation = <span class="literal">false</span></span><br><span class="line">            <span class="comment">-- 是否出现动画（打勾打叉）</span></span><br><span class="line">            room:judge(judge)</span><br><span class="line">            <span class="comment">-- 执行判定</span></span><br><span class="line">            <span class="keyword">if</span> p:isAlive() <span class="keyword">and</span> <span class="keyword">not</span> p:canDiscard(p, <span class="string">"he"</span>) <span class="keyword">or</span> <span class="keyword">not</span> room:askForCard(p, <span class="string">".|"</span> .. judge.pattern, <span class="string">"@LuaTieji-discard:"</span> .. judge.pattern, data, sgs.Card_MethodDiscard) <span class="keyword">then</span></span><br><span class="line">                <span class="comment">--[[</span></span><br><span class="line"><span class="comment">                    canDiscard 函数返回布尔值，代表是否可以弃置对应区域的牌</span></span><br><span class="line"><span class="comment">                    askForCard 函数比较复杂，将其原型列出：</span></span><br><span class="line"><span class="comment">                        const Card *askForCard(ServerPlayer *player, const QString &amp;pattern, const QString &amp;prompt, const QVariant &amp;data = QVariant(), Card::HandlingMethod method = Card::MethodDiscard, ServerPlayer *to = NULL, bool isRetrial = false, const QString &amp;skill_name = QString(), bool isProvision = false);</span></span><br><span class="line"><span class="comment">                        我们关心前几个参数：</span></span><br><span class="line"><span class="comment">                        player：被询问要求选择卡牌的角色</span></span><br><span class="line"><span class="comment">                        pattern：要求卡牌的格式（例如花色、颜色、点数）</span></span><br><span class="line"><span class="comment">                        prompt：提示信息，可使用格式字符串</span></span><br><span class="line"><span class="comment">                        data：忽略</span></span><br><span class="line"><span class="comment">                        method：卡牌的选择类型，例如这里是要求弃牌</span></span><br><span class="line"><span class="comment">                        后略</span></span><br><span class="line"><span class="comment">                ]]</span><span class="comment">--</span></span><br><span class="line">                room:addPlayerMark(p, <span class="string">'LuaTiejiDamageUp'</span>)</span><br><span class="line">                <span class="comment">-- 添加增伤害标记</span></span><br><span class="line">                <span class="keyword">local</span> msg = sgs.LogMessage()</span><br><span class="line">                msg.<span class="built_in">type</span> = <span class="string">'#NoJink'</span></span><br><span class="line">                msg.from = p</span><br><span class="line">                room:sendLog(msg)</span><br><span class="line">                <span class="comment">-- 发送特定信息</span></span><br><span class="line">                jink_table[index] = <span class="number">0</span></span><br><span class="line">                <span class="comment">-- 可以理解为提前为闪的信息标记为无，代表玩家没有使用【闪】</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        index = index + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> jink_data = sgs.QVariant()</span><br><span class="line">    jink_data:setValue(Table2IntList(jink_table))</span><br><span class="line">    <span class="comment">-- 应用【杀】的信息，把没有弃牌的统统安排</span></span><br><span class="line">    player:setTag(<span class="string">"Jink_"</span> .. use.card:toString(), jink_data)</span><br><span class="line">    <span class="comment">-- 使用一个 Tag 存储对应的卡牌信息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h4 id="处理判定"><a href="#处理判定" class="headerlink" title="处理判定"></a>处理判定</h4><p>还记得我们询问弃牌时的 <code>pattern</code> 吗？是和 <code>judge.pattern</code> 挂钩的，但是原来的 <code>pattern</code> 是 <code>.</code>，也就是什么类型的都行，但是马神只要求一种花色，因此我们需要在判定结束后进行修正：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> judge = data:toJudge()</span><br><span class="line"><span class="keyword">if</span> judge.reason == self:objectName() <span class="keyword">then</span></span><br><span class="line">    judge.pattern = judge.card:getSuitString()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>如此一来，judge 的 pattern 就被更换成了判定牌的花色了，也可以在格式字符串中进行说明。</p>
<h4 id="造成伤害"><a href="#造成伤害" class="headerlink" title="造成伤害"></a>造成伤害</h4><p>马神对那些不弃牌的人从不留情！因此我们只需要判断之前是否在他身上留下过标记即可：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> damage = data:toDamage()</span><br><span class="line"><span class="comment">-- 获取伤害结构体</span></span><br><span class="line"><span class="keyword">if</span> damage.chain <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 马神是很精准的，只加伤一次，传导伤害将不受到此影响（铁索连环）</span></span><br><span class="line"><span class="comment">-- 如果需要改成伤害转移（例如天香、誓仇（☆SP刘备）），则是 damage.transfer</span></span><br><span class="line"><span class="comment">-- 当然也可以同时添加</span></span><br><span class="line"><span class="keyword">if</span> damage.to:getMark(<span class="string">'LuaTiejiDamageUp'</span>) &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 如果有增伤标记</span></span><br><span class="line">    damage.damage = damage.damage + <span class="number">1</span></span><br><span class="line">    <span class="comment">-- 加伤害</span></span><br><span class="line">    room:removePlayerMark(damage.to, <span class="string">'LuaTiejiDamageUp'</span>)</span><br><span class="line">    <span class="comment">-- 移除标记</span></span><br><span class="line">    room:doAnimate(<span class="number">1</span>, damage.from:objectName(), damage.to:objectName())</span><br><span class="line">    <span class="comment">-- 画线</span></span><br><span class="line">    <span class="keyword">local</span> msg = sgs.LogMessage()</span><br><span class="line">    msg.<span class="built_in">type</span> = <span class="string">'#LuaTiejiDamageUp'</span></span><br><span class="line">    msg.from = player</span><br><span class="line">    <span class="keyword">if</span> damage.card <span class="keyword">and</span> <span class="keyword">not</span> damage.card:isVirtualCard() <span class="keyword">then</span></span><br><span class="line">        msg.card_str = damage.card:getEffectiveId()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        msg.<span class="built_in">type</span> = <span class="string">'#LuaTiejiDamageUpVirtualCard'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 消息结构体，请参照学习手册</span></span><br><span class="line">    room:notifySkillInvoked(player, self:objectName())</span><br><span class="line">    <span class="comment">-- 在你的武将处显示一下技能名称</span></span><br><span class="line">    room:sendLog(msg)</span><br><span class="line">    <span class="comment">-- 发信息</span></span><br><span class="line">    data:setValue(damage)</span><br><span class="line">    <span class="comment">-- 将 damage 回写，应用修改</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h4 id="清理残留"><a href="#清理残留" class="headerlink" title="清理残留"></a>清理残留</h4><h5 id="回收多余的增伤标记"><a href="#回收多余的增伤标记" class="headerlink" title="回收多余的增伤标记"></a>回收多余的增伤标记</h5><p>有些情况可能会提前地将伤害过程取消掉，因此我们需要在【杀】结算完成后，清除掉尚存的标记。<br>时机是 CardFinished<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> use = data:toCardUse()</span><br><span class="line"><span class="keyword">local</span> card = use.card</span><br><span class="line"><span class="keyword">if</span> card:isKindOf(<span class="string">'Slash'</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">for</span> _, p <span class="keyword">in</span> sgs.qlist(room:getAlivePlayers()) <span class="keyword">do</span></span><br><span class="line">        room:setPlayerMark(p, <span class="string">'LuaTiejiDamageUp'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h5 id="取消技能封锁"><a href="#取消技能封锁" class="headerlink" title="取消技能封锁"></a>取消技能封锁</h5><p>马神的技能封锁仅仅持续一回合，因此需要在回合结束时解除，同时还要考虑到另一个情况——一个不可能的事态已然发生——马神的陨落。因此，我们对于这两种情况，有如下的判断考虑：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> event == sgs.EventPhaseChanging <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> change = data:toPhaseChange()</span><br><span class="line">    <span class="keyword">if</span> change.to == sgs.Player_NotActive <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 判断是否切换到回合结束</span></span><br><span class="line"><span class="keyword">elseif</span> event == sgs.Death <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> death = data:toDeath()</span><br><span class="line">    <span class="keyword">if</span> death.who:objectName() ~= player:objectName() <span class="keyword">or</span></span><br><span class="line">        player:objectName() ~= room:getCurrent():objectName() <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 判断死的是否为当前角色/当前回合角色</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 如果条件满足，我们撤销对应的标记</span></span><br></pre></td></tr></table></figure></p>
<p>基于此，我们也是很常规的将标记取消，并恢复 <code>filterCards</code> 操作<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, p <span class="keyword">in</span> sgs.qlist(room:getAllPlayers()) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> p:getMark(<span class="string">"LuaTieji"</span>) &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        room:removePlayerMark(p, <span class="string">"@skill_invalidity"</span>, p:getMark(<span class="string">'LuaTieji'</span>))</span><br><span class="line">        <span class="comment">-- 根据 LuaTieji 的数量清除标记，因为其他技能可能引入</span></span><br><span class="line">        room:setPlayerMark(p, <span class="string">"LuaTieji"</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="comment">-- 清除 LuaTieji 标记</span></span><br><span class="line">        <span class="keyword">for</span> _, pl <span class="keyword">in</span> sgs.qlist(room:getAllPlayers()) <span class="keyword">do</span></span><br><span class="line">            room:filterCards(pl, pl:getCards(<span class="string">'he'</span>), <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 还原所有角色的 filterCards</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>整体而言，我们的【铁骑】技能就完成了。总代码如下：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">LuaTieji = sgs.CreateTriggerSkill &#123;</span><br><span class="line">    name = <span class="string">'LuaTieji'</span>,</span><br><span class="line">    frequency = sgs.Skill_NotFrequent,</span><br><span class="line">    events = &#123;</span><br><span class="line">        sgs.TargetSpecified, sgs.FinishJudge, sgs.EventPhaseChanging, sgs.Death,</span><br><span class="line">        sgs.DamageCaused, sgs.CardFinished</span><br><span class="line">    &#125;,</span><br><span class="line">    on_trigger = <span class="function"><span class="keyword">function</span><span class="params">(self, event, player, data, room)</span></span></span><br><span class="line">        <span class="keyword">if</span> event == sgs.TargetSpecified <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> RIGHT(self, player) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> use = data:toCardUse()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> use.card:isKindOf(<span class="string">'Slash'</span>) <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">local</span> jink_table = sgs.QList2Table(</span><br><span class="line">                                       player:getTag(</span><br><span class="line">                                           <span class="string">"Jink_"</span> .. use.card:toString())</span><br><span class="line">                                           :toIntList())</span><br><span class="line">                <span class="keyword">local</span> index = <span class="number">1</span></span><br><span class="line">                <span class="keyword">local</span> tos = sgs.SPlayerList()</span><br><span class="line">                <span class="keyword">for</span> _, p <span class="keyword">in</span> sgs.qlist(use.to) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> player:isAlive() <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">local</span> data2 = sgs.QVariant()</span><br><span class="line">                    data2:setValue(p)</span><br><span class="line">                    <span class="keyword">if</span> room:askForSkillInvoke(player, self:objectName(), data2) <span class="keyword">then</span></span><br><span class="line">                        room:broadcastSkillInvoke(self:objectName())</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> tos:contains(p) <span class="keyword">then</span></span><br><span class="line">                            room:addPlayerMark(p, <span class="string">'LuaTieji'</span>)</span><br><span class="line">                            room:addPlayerMark(p, <span class="string">'@skill_invalidity'</span>)</span><br><span class="line">                            room:doAnimate(<span class="number">1</span>, player:objectName(),</span><br><span class="line">                                           p:objectName())</span><br><span class="line">                            tos:append(p)</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> _, pl <span class="keyword">in</span> sgs.qlist(room:getAllPlayers()) <span class="keyword">do</span></span><br><span class="line">                                room:filterCards(pl, pl:getCards(<span class="string">'he'</span>), <span class="literal">true</span>)</span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">local</span> judge = sgs.JudgeStruct()</span><br><span class="line">                        judge.pattern = <span class="string">"."</span></span><br><span class="line">                        judge.good = <span class="literal">true</span></span><br><span class="line">                        judge.reason = self:objectName()</span><br><span class="line">                        judge.who = player</span><br><span class="line">                        judge.play_animation = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">                        room:judge(judge)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> p:isAlive() <span class="keyword">and</span> <span class="keyword">not</span> p:canDiscard(p, <span class="string">"he"</span>) <span class="keyword">or</span></span><br><span class="line">                            <span class="keyword">not</span> room:askForCard(p, <span class="string">".|"</span> .. judge.pattern,</span><br><span class="line">                                                <span class="string">"@LuaTieji-discard:"</span> ..</span><br><span class="line">                                                    judge.pattern, data,</span><br><span class="line">                                                sgs.Card_MethodDiscard) <span class="keyword">then</span></span><br><span class="line">                            room:addPlayerMark(p, <span class="string">'LuaTiejiDamageUp'</span>)</span><br><span class="line">                            <span class="keyword">local</span> msg = sgs.LogMessage()</span><br><span class="line">                            msg.<span class="built_in">type</span> = <span class="string">'#NoJink'</span></span><br><span class="line">                            msg.from = p</span><br><span class="line">                            room:sendLog(msg)</span><br><span class="line">                            jink_table[index] = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    index = index + <span class="number">1</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">local</span> jink_data = sgs.QVariant()</span><br><span class="line">                jink_data:setValue(Table2IntList(jink_table))</span><br><span class="line">                player:setTag(<span class="string">"Jink_"</span> .. use.card:toString(), jink_data)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.FinishJudge <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> judge = data:toJudge()</span><br><span class="line">            <span class="keyword">if</span> judge.reason == self:objectName() <span class="keyword">then</span></span><br><span class="line">                judge.pattern = judge.card:getSuitString()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.DamageCaused <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> damage = data:toDamage()</span><br><span class="line">            <span class="keyword">if</span> damage.chain <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">if</span> damage.to:getMark(<span class="string">'LuaTiejiDamageUp'</span>) &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                damage.damage = damage.damage + <span class="number">1</span></span><br><span class="line">                room:removePlayerMark(damage.to, <span class="string">'LuaTiejiDamageUp'</span>)</span><br><span class="line">                room:doAnimate(<span class="number">1</span>, damage.from:objectName(),</span><br><span class="line">                               damage.to:objectName())</span><br><span class="line">                <span class="keyword">local</span> msg = sgs.LogMessage()</span><br><span class="line">                msg.<span class="built_in">type</span> = <span class="string">'#LuaTiejiDamageUp'</span></span><br><span class="line">                msg.from = player</span><br><span class="line">                <span class="keyword">if</span> damage.card <span class="keyword">and</span> <span class="keyword">not</span> damage.card:isVirtualCard() <span class="keyword">then</span></span><br><span class="line">                    msg.card_str = damage.card:getEffectiveId()</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    msg.<span class="built_in">type</span> = <span class="string">'#LuaTiejiDamageUpVirtualCard'</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                room:notifySkillInvoked(player, self:objectName())</span><br><span class="line">                room:sendLog(msg)</span><br><span class="line">                data:setValue(damage)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> event == sgs.CardFinished <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> use = data:toCardUse()</span><br><span class="line">            <span class="keyword">local</span> card = use.card</span><br><span class="line">            <span class="keyword">if</span> card:isKindOf(<span class="string">'Slash'</span>) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _, p <span class="keyword">in</span> sgs.qlist(room:getAlivePlayers()) <span class="keyword">do</span></span><br><span class="line">                    room:setPlayerMark(p, <span class="string">'LuaTiejiDamageUp'</span>, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">if</span> event == sgs.EventPhaseChanging <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> change = data:toPhaseChange()</span><br><span class="line">                <span class="keyword">if</span> change.to == sgs.Player_NotActive <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">elseif</span> event == sgs.Death <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> death = data:toDeath()</span><br><span class="line">                <span class="keyword">if</span> death.who:objectName() ~= player:objectName() <span class="keyword">or</span></span><br><span class="line">                    player:objectName() ~= room:getCurrent():objectName() <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">for</span> _, p <span class="keyword">in</span> sgs.qlist(room:getAllPlayers()) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> p:getMark(<span class="string">"LuaTieji"</span>) &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                    room:removePlayerMark(p, <span class="string">"@skill_invalidity"</span>,</span><br><span class="line">                                          p:getMark(<span class="string">'LuaTieji'</span>))</span><br><span class="line">                    room:setPlayerMark(p, <span class="string">"LuaTieji"</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> _, pl <span class="keyword">in</span> sgs.qlist(room:getAllPlayers()) <span class="keyword">do</span></span><br><span class="line">                        room:filterCards(pl, pl:getCards(<span class="string">'he'</span>), <span class="literal">false</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    can_trigger = <span class="function"><span class="keyword">function</span><span class="params">(self, target)</span></span> <span class="keyword">return</span> target <span class="keyword">end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到此为止，我们的马神技能就初步设计完成。</p>
<h3 id="为马神的技能启用简单的-AI"><a href="#为马神的技能启用简单的-AI" class="headerlink" title="为马神的技能启用简单的 AI"></a>为马神的技能启用简单的 AI</h3><p>在初步设计完成时，我们没有考虑到马神可能成为队友的情况，如此强劲的马神，如果成了我们的队友，国安民乐，岂不美哉？<br>但是在实际操作时发现，马神不会使用技能【铁骑】，【马术】也是乱指定目标，时不时给队友来一刀，严重影响了体验，因此，我们在这里简单地为马神写两个 AI。<br>说是 AI，其实就是决策树，满足某个条件时就返回对应的数据。<br>我们在 <code>QSanguosha/lua/ai</code> 下创建对应的 AI 文件，比方说我的马神放在 <code>Jiaqiang.lua</code> 文件中，对应的 AI 文件名则是 <code>Jiaqiang-ai.lua</code>。也即是 <code>lua文件名-ai.lua</code>。</p>
<h4 id="铁骑-1"><a href="#铁骑-1" class="headerlink" title="铁骑"></a>铁骑</h4><p>对于【铁骑】，我们做如下考虑，很明显这技能对队友不能发动，对敌人那就一定发动。因此有：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sgs.ai_skill_invoke.LuaTieji = <span class="function"><span class="keyword">function</span><span class="params">(self,data)</span></span></span><br><span class="line">	<span class="keyword">local</span> target = data:toPlayer()</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> self:isFriend(target) <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>在这里，我们采用了回调函数 <code>sgs.ai_skill_invoke.技能名</code>，该函数返回对应的布尔值，作用于 <code>room:askForSkillInvoke</code>，因此我们判断对应的目标是否为队友即可。类似的函数可以参照目录下的其他 AI 文件。<br>对于【铁骑】的弃牌，我没有特别的写，因此 AI 会看情况是否弃牌，总体来讲弃牌效果是优于原版 AI 的，因此不做改动。</p>
<h4 id="马术-1"><a href="#马术-1" class="headerlink" title="马术"></a>马术</h4><p>马术的话，我们也简单考虑，考虑成对需要出杀的人使用技能，照搬现有代码我们有：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sgs.ai_skill_playerchosen.LuaMashu = <span class="function"><span class="keyword">function</span><span class="params">(self, targetlist)</span></span></span><br><span class="line">	<span class="keyword">local</span> targets = sgs.QList2Table(targetlist)</span><br><span class="line">	self:<span class="built_in">sort</span>(targets)</span><br><span class="line">	<span class="keyword">local</span> friends, enemies = &#123;&#125;, &#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, target <span class="keyword">in</span> <span class="built_in">ipairs</span>(targets) <span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span> self:cantbeHurt(target, self.player) <span class="keyword">or</span> <span class="keyword">not</span> self:damageIsEffective(target, <span class="literal">nil</span>, self.player) <span class="keyword">then</span> continue <span class="keyword">end</span></span><br><span class="line">		<span class="keyword">if</span> self:isEnemy(target) <span class="keyword">then</span> <span class="built_in">table</span>.<span class="built_in">insert</span>(enemies, target)</span><br><span class="line">		<span class="keyword">elseif</span> self:isFriend(target) <span class="keyword">then</span> <span class="built_in">table</span>.<span class="built_in">insert</span>(friends, target) <span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">for</span> _, enemy <span class="keyword">in</span> <span class="built_in">ipairs</span>(enemies) <span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> self:getDamagedEffects(enemy, self.player) <span class="keyword">and</span> <span class="keyword">not</span> self:needToLoseHp(enemy, self.player) <span class="keyword">then</span> <span class="keyword">return</span> enemy <span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">for</span> _, friend <span class="keyword">in</span> <span class="built_in">ipairs</span>(friends) <span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span> self:getDamagedEffects(friend, self.player) <span class="keyword">and</span> self:needToLoseHp(friend, self.player) <span class="keyword">then</span> <span class="keyword">return</span> friend <span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>至此，一个强大的、比较聪明的马神就诞生辣！</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Lua/" rel="tag"># Lua</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/19/CSAPP4/index.html" rel="next" title="深入理解《深入理解计算机系统》（四）">
                <i class="fa fa-chevron-left"></i> 深入理解《深入理解计算机系统》（四）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/11/30/offer1/index.html" rel="prev" title="《剑指 Offer》笔记一">
                《剑指 Offer》笔记一 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80NDQ4NS8yMTAxNw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/blog-logo.jpg" alt="Chin">
            
              <p class="site-author-name" itemprop="name">Chin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#动手写代码"><span class="nav-number">2.</span> <span class="nav-text">动手写代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建我们的武将"><span class="nav-number">2.1.</span> <span class="nav-text">创建我们的武将</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设计我们的武将技能"><span class="nav-number">2.2.</span> <span class="nav-text">设计我们的武将技能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动手写码"><span class="nav-number">2.3.</span> <span class="nav-text">动手写码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#马术"><span class="nav-number">2.3.1.</span> <span class="nav-text">马术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#触发时机"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">触发时机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码部分"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">代码部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#伤害处理"><span class="nav-number">2.3.1.2.1.</span> <span class="nav-text">伤害处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#结束阶段判断"><span class="nav-number">2.3.1.2.2.</span> <span class="nav-text">结束阶段判断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基础马术"><span class="nav-number">2.3.1.2.3.</span> <span class="nav-text">基础马术</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总代码"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">总代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#铁骑"><span class="nav-number">2.3.2.</span> <span class="nav-text">铁骑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#触发时机-1"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">触发时机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考源码"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">参考源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本框架"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">基本框架</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#目标选择时"><span class="nav-number">2.3.2.4.</span> <span class="nav-text">目标选择时</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理判定"><span class="nav-number">2.3.2.5.</span> <span class="nav-text">处理判定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#造成伤害"><span class="nav-number">2.3.2.6.</span> <span class="nav-text">造成伤害</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#清理残留"><span class="nav-number">2.3.2.7.</span> <span class="nav-text">清理残留</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#回收多余的增伤标记"><span class="nav-number">2.3.2.7.1.</span> <span class="nav-text">回收多余的增伤标记</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#取消技能封锁"><span class="nav-number">2.3.2.7.2.</span> <span class="nav-text">取消技能封锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为马神的技能启用简单的-AI"><span class="nav-number">2.3.3.</span> <span class="nav-text">为马神的技能启用简单的 AI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#铁骑-1"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">铁骑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#马术-1"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">马术</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">46k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>


  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
